<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background:#eef7f7; padding:30px; text-align:center; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
    th, td { border:1px solid #ddd; padding:8px; }
    th { background:#00796b; color:#fff; }
    input { padding:8px; width:200px; margin:0 5px;}
    button { padding:8px 12px; margin:5px; background:#00796b;color:#fff;border:none;cursor:pointer; }
    button:hover { background:#004d40; }
  </style>
</head>
<body>
  <h2>Admin Dashboard</h2>
  <input type="text" id="search" placeholder="Search"><button onclick="filter()">Search</button>
  <button onclick="download()">Download Excel</button>
  <button onclick="logout()">Logout</button>
  <table id="tbl"><thead><tr><th>Username</th><th>Full Name</th><th>Phone</th><th>Institute</th><th>DOB</th><th>Gender</th><th>Actions</th></tr></thead><tbody></tbody></table>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA3ZVHmeCvfdfYj4RH6D7nos1_XlS7zoL8",
      authDomain: "sscresult-b774b.firebaseapp.com",
      projectId: "sscresult-b774b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const role = sessionStorage.getItem("userRole");
    if (role !== "admin") location.href = "index.html";

    let all = [];
    db.collection("users").get().then(snap => {
      snap.forEach(doc => {
        const u = { id: doc.id, ...doc.data() };
        all.push(u);
        append(u);
      });
    });

    function append(u){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${u.username}</td><td>${u.fullName}</td><td>${u.phone}</td><td>${u.institute}</td><td>${u.dob}</td><td>${u.gender}</td>
        <td><button onclick="del('${u.id}')">Delete</button><button onclick="edit('${u.id}')">Edit</button></td>`;
      document.querySelector("#tbl tbody").appendChild(tr);
    }

    function filter(){
      const term = document.getElementById("search").value.toLowerCase();
      document.querySelectorAll("#tbl tbody tr").forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(term) ? "" : "none";
      });
    }

    function del(id){
      if (!confirm("Confirm delete?")) return;
      db.collection("users").doc(id).delete().then(()=>location.reload());
    }

    function edit(id){
      const f = all.find(u=>u.id===id);
      const fn = prompt("Full Name:", f.fullName);
      if (fn===null) return;
      const ph = prompt("Phone:", f.phone);
      const inst = prompt("Institute:", f.institute);
      const dob = prompt("DOB:", f.dob);
      const g = prompt("Gender:", f.gender);
      const pwd = prompt("Password:", f.password);
      db.collection("users").doc(id).update({ fullName: fn, phone: ph, institute: inst, dob, gender: g, password: pwd }).then(()=>location.reload());
    }

    function download(){
      const data = all.map(u=>{ const {id, ...rest} = u; return rest; });
      const ws = XLSX.utils.json_to_sheet(data), wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Users");
      XLSX.writeFile(wb, "users.xlsx");
    }

    function logout(){
      sessionStorage.clear(); location.href="index.html";
    }
  </script>
</body>
</html>
